# ACID. ISOLATION & PROPAGATION

## ACID

**Atomicity** — Каждый запрос в транзакции будет выполнен успешно, либо вообще никакой, в случае ошибки одного.
**Consistency** — После транзакции база остаётся в корректном, непротиворечивом состоянии. Каждая успешная транзакция по
определению фиксирует только допустимые результаты.
**Isolation** — Все транзакции будут выполняться изолированно.
**Durability** — После commit данные не теряются, даже при падении сервера.

---

## Isolation (Изоляция)

### Проблемы

1. **Потеря обновлений (Lost update)** — несколько транзакций одновременно могут считывать и обновлять одни данные. При
   этом теряются все обновления данных, за исключением обновлений, выполненных последней транзакцией.
2. **Грязное чтение (Dirty Read)** — транзакция видит незафиксированные изменения другой транзакции.
3. **Неповторяющееся чтение (Non-Repeatable Read)** — одинаковый запрос в одной транзакции может вернуть разные данные
   существующих записей.
4. **Фантомное чтение (Phantom Read)** — одинаковый запрос может вернуть НОВЫЕ строки, закомиченые из другой транзакции.

### Уровни изоляции

1. **Read uncommitted** — худшая согласованность данных, лучшая скорость. Не задаёт блокировок, игнорирует уже заданные.

   _Допускает:_ грязное чтение, неповторяемое чтение и фантомы.
2. **Read committed** — транзакции видят только зафиксированные изменения из других транзакций.

   _Допускает:_ неповторяемое чтение и фантомы. Решает: грязное чтение.
3. **Repeatable read** — не видим в исполняющейся транзакции измененные и удаленные записи другой транзакцией.

   _Допускает:_ фантомы. Решает: грязное чтение, Неповторяющееся чтение.
4. **Serializable** — обеспечивает беспрепятственный доступ SELECT транзакциям. Но для UPDATE и DELETE не допускает
   модификации одной и той же строки в рамках разных транзакций. Транзакции обрабатываются одна за другой. Если две
   одновременные транзакции попытаются обновить одну и туже строку, то это будет не возможно.

По умолчанию в PostgreSQL уровень изоляции Read Committed

---

## Propagation (Распространение)

Распространение определяет границу транзакции нашей бизнес-логики. Spring удается запустить и приостановить транзакцию в
соответствии с нашей настройкой.

- **REQUIRED** — (по умолчанию) Spring проверяет, есть ли активная транзакция, и если ничего не существует, создает новую. В
  противном случае бизнес-логика добавляется к текущей активной транзакции:
- **SUPPORTS** — Если транзакция существует, то будет использована существующая транзакция. Если транзакции нет, она
  выполняется нетранзакционно.
- **MANDATORY** — Если есть активная транзакция, она будет использована. Если активной транзакции нет, Spring выдает
  исключение.
- **NEVER** — Выдает исключение, если есть активная транзакция.
- **NOT_SUPPORTED** — Если текущая транзакция существует, Spring сначала приостанавливает ее, а затем выполняется
  бизнес-логика без транзакции.
- **REQUIRES_NEW** — Приостанавливает текущую транзакцию, если она существует, а затем создает новую.
- **NESTED** — Spring проверяет, существует ли транзакция, и если да, то отмечает точку сохранения. Это означает, что если
  выполнение нашей бизнес-логики выдает исключение, транзакция откатывается к этой точке сохранения. Если активной
  транзакции нет, она работает как REQUIRED.