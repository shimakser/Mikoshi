# MVCC. Vacuum

## MVCC (Multi-Version Concurrency Control)
**Snapshot isolation** — это уровень изоляции транзакций, при котором каждая транзакция работает с консистентным снимком данных на момент её начала. Другими словами, транзакция видит данные такими, какими они были в момент старта, игнорируя изменения, внесённые параллельными транзакциями после её запуска. При этом транзакция не блокирует чтение данных и не блокируется сама при чтении.


## Vacuum

В системах с MVCC (например, PostgreSQL) старые версии строк не удаляются сразу, чтобы обеспечить изоляцию транзакций, а остаются в таблицах до запуска VACUUM.

### Почему это важно
- Без регулярного запуска VACUUM таблицы накапливают "мертвые" кортежи (dead tuples), что приводит к раздуванию таблиц (table bloat) и ухудшению производительности.
- Кроме того, VACUUM предотвращает проблему wraparound transaction ID, которая может привести к ошибкам целостности данных из-за переполнения счётчика транзакций.

### XID wraparound
- В PostgreSQL каждая транзакция получает уникальный 32-битный идентификатор —  XID.
- Из-за ограниченного размера счётчик XID может принимать примерно 4 миллиарда значений, после чего происходит переполнение (wraparound) — счётчик начинает заново с минимального значения.
- PostgreSQL использует механизм MVCC, где каждая строка содержит два скрытых поля: xmin (XID транзакции, которая создала) и xmax.
- Если строка с "старым" XID не будет заморожена и останется в таблице слишком долго, то после переполнения счётчика новая транзакция может ошибочно считать эту строку созданной в будущем, что приведёт к ошибкам в видимости данных.

### Виды
1. **Plain VACUUM** — Обычная очистка мертвых строк, освобождает место для повторного использования внутри таблицы.
   - Не блокирует таблицу (конкурентный).
    - Работает параллельно с чтением и записью.
2. **VACUUM FULL** — Полная очистка — переписывает таблицу заново в новый файл, физически освобождая место, что позволяет ОС вернуть дисковое пространство.
   - Требует эксклюзивной блокировки.
   - Медленнее, но освобождает место ОС.
3. **VACUUM FREEZE** — Помечает старые строки как "замороженные", предотвращая проблемы с переполнением идентификаторов транзакций.
   - Не блокирует таблицу.
   - Используется для предотвращения wraparound.
4. **VACUUM ANALYZE** — Выполняет VACUUM и обновляет статистику для планировщика запросов.
   - Не блокирует таблицу.
   - Помогает оптимизировать планы запросов.

**Autovacuum** — фоновый процесс, который автоматически запускает VACUUM и ANALYZE по мере необходимости, без вмешательства администратора.
