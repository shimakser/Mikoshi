# Load Balancing

Распределение входящих запросов между множеством серверов.

## Методы
- Round-Robin (по очереди).
- По нагрузке (отправлять на менее загруженный).
- Sticky Sessions (отправлять пользователя всегда на один и тот же сервер).

## Варианты реализации
- DNS (через A-записи с разными IP).
- HAProxy, LVS – софтварные решения.
- Аппаратные балансировщики (F5, Citrix) — дорогие.

## Взаимодействие с DNS
Обычно клиент взаимодействует с балансировщиком по доменному имени.
- Клиент выполняет DNS-запрос A или AAAA для имени api.example.com.
- DNS возвращает один или несколько IP-адресов — обычно это IP балансировщика (или прокси-сервиса, например Cloudflare).
- Клиент инициирует соединение по IP балансировщика.
- Балансировщик сам определяет, куда отправить запрос — на какой backend.
- DNS не знает о реальных бэкендах и не участвует в балансировке на уровне конкретных серверов, если используется стандартный подход.

---

## Балансировщики (по модели OSI)
1. L3
    - Редко используется как отдельная категория, но может иметь смысл, особенно при работе с маршрутизаторами.
    - Маршрутизация трафика по IP без учёта портов/протоколов.

2. L4 — Network Load Balancer. Быстрая и простая балансировка по IP/портам (TCP/UDP).
    - Оперирует TCP/UDP заголовками.
    - Решения принимаются на основе IP-адресов источника/получателя и портов.
    - Не "знает" содержимого пакета (нет доступа к HTTP-заголовкам или телу запроса).
    - Очень быстрый, минимальный overhead.
    - Используется для low-latency и high-throughput приложений (например, VoIP, гейминг, MQTT, TLS passthrough).

3. L5-L6
    - Контролируют TLS session, SSL handshake, SNI.
    - Поддерживают sticky sessions по TLS session ID.
    - Важны для HTTPS проксирования без расшифровки.

4. L7 — Application Load Balancer. Умная маршрутизация по контенту (HTTP, HTTPS).
    - Работает на уровне приложений (Layer 7).
    - Понимает HTTP, HTTPS, WebSocket, gRPC, SMTP, FTP протоколы.
    - Маршрутизацию по Host, Path, Cookie, Header.
    - Может выполнять SSL/TLS termination (раскрытие TLS-трафика на себе).
    - Позволяет content-based routing (напр., один URL к одному сервису, другой — к другому).
    - Rate Limiting, Caching, WAF (в L7-proxy).
    - Имеет больше логики, следовательно — выше задержки, но даёт гибкость.

5. DNS
    - Уровень L3/L7 (через DNS).

6. Global
    - Уровень L4/L7 (с Anycast IP или TCP proxy).

## Use case
- L4: распределение трафика по микросервисам без разборки протокола.
- L7: гибкое управление трафиком между сервисами API Gateway-style.

## Недостатоки балансировщика нагрузки
- Балансировщик нагрузки может стать узким местом в производительности, если у него недостаточно ресурсов или если он неправильно настроен.
- Внедрение балансировщика нагрузки для устранения единой точки отказа приводит к увеличению сложности.
- Один балансировщик нагрузки - это единственная точка отказа, а настройка нескольких балансировщиков нагрузки еще больше увеличивает сложность.
