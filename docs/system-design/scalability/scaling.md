# Scaling

**Масштабирование** — это способность системы выдерживать рост нагрузки (по количеству пользователей, запросов, данных или событий) без деградации производительности или доступности.

##  Scaling options

### Vertical scaling (Scale-Up)

_Описание:_ Увеличение вычислительных ресурсов одного узла: CPU, RAM, SSD, сетевой пропускной способности.

_Применение:_
- Простые монолитные приложения.
- Базы данных, требующие сильной консистентности (PostgreSQL, Oracle).
- Временное решение при ограниченном бюджете на архитектурные изменения.

_Плюсы:_
- Проще в реализации: не нужно изменять код.
- Нет проблем с синхронизацией данных между машинами.
- Предсказуемое поведение: latency и throughput масштабируются линейно.

_Минусы:_
- Аппаратный предел (нельзя бесконечно наращивать).
- Более мощное «железо» — дороже.
- Если сервер упал — всё сломалось.
- Downtime при апгрейде.

_Типичные метрики масштабирования:_
- CPU utilization.
- I/O wait time.
- Context switching rate.
- DB query latency (часто bottleneck при вертикальном росте).

### Horizontal scaling (Scale-Out)

_Описание:_ Добавление новых узлов (инстансов) в систему. Вместо одного «большого» сервера — множество меньших, работающих совместно.

_Типичные сценарии:_
- Веб-сервера за балансировщиком.
- Шардинг или репликация баз данных.
- Кластеры Kafka, Cassandra, Redis Cluster, Elasticsearch.

_Плюсы:_
- Потенциально неограниченное масштабирование (в рамках архитектуры).
- Отказоустойчивость и self-healing.
- Возможность геораспределённости (multi-region).

_Минусы:_
- Рост сложности: координация, консистентность, синхронизация данных.
- Необходимость балансировки нагрузки.
- Проблемы с состоянием (stateful vs stateless).
- Распределённые сбои и сложность отладки.

_Типичные подходы:_
- Replication: каждый узел хранит полные данные (повышает отказоустойчивость, но усложняет консистентность).
- Partitioning / Sharding: каждый узел хранит подмножество данных.
- Shared-Nothing architecture: каждый узел независим, без общей памяти или дисков.

## Stateless vs Stateful

_Почему stateless сервисы проще масштабировать?_

_Stateless сервисы:_
- Каждый запрос полностью автономен.
- Нет локального состояния (сессий, кешей, транзакций).
- Масштабируются горизонтально без ограничений.

_Примеры:_ REST-API, CDN edge nodes, frontend-gateways.

_Stateful сервисы:_
- Держат сессию, соединение или состояние пользователя в памяти или на локальном диске.
- Масштабируются только при согласованном хранении состояния (через Redis, DB, session store).

_Решения:_
- Вынести состояние во внешние системы (Redis, DB, message broker).
- Sticky sessions — временный компромисс, но мешают балансировке.

## Elastic scaling

_Цель:_ динамическая адаптация числа инстансов под текущую нагрузку (Auto-Scaling).

_Типы триггеров:_
- **Reactive**: масштабирование на основе метрик (CPU, latency, queue depth).
- **Predictive**: на основе трендов, исторических данных, ML-моделей.
- **Scheduled**: заранее заданное расписание (например, часы пик).

_Ключевые параметры:_
- **Scale-out threshold**: метрика, при которой добавляется новый инстанс.
- **Scale-in threshold**: метрика, при которой удаляется инстанс.
- **Cooldown period**: время стабилизации после масштабирования.

_Пример:_ Kubernetes — Horizontal Pod Autoscaler (HPA).

## Bottlenecks

| Компонент       | Симптом                       | Возможное решение                           |
| --------------- | ----------------------------- | ------------------------------------------- |
| CPU             | Высокий CPU usage             | Профилирование кода, кэширование, scale-out |
| Memory          | OutOfMemory, GC pauses        | Оптимизация структур данных, heap tuning    |
| Disk I/O        | Медленные запросы БД          | SSD, query optimization, read replicas      |
| Network         | High latency, packet loss     | CDN, data locality, gRPC batching           |
| DB connections  | Connection pool exhaustion    | Connection pool tuning, DB scaling          |
| Lock contention | Thread blocking, high latency | Lock striping, partitioning                 |

